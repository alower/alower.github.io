---
title: 操作系统：设备管理
date: 2021-04-24 09:54:27
tags:
---

> 设备管理的基本任务是完成用户提出的I/O请求，提高I/O速率以及提高I/O设备利用率。
>
> 设备管理的基本功能：缓冲区管理，设备分配，设备处理，虚拟设备及实现设备设备独立性

### 1 I/O系统

#### 1.1 I/O设备

｜I/O设备类型

1. 按设备使用特性分类。存储设备，输入/输出设备
2. 按传输速率分类。低速设备，中速设备，高速设备
3. 按信息交换单位分类。块设备，字符设备
4. 按设备共享属性。独占设备，共享设备，虚拟设备

｜设备与控制器之间的接口

设备通常不直接与CPU进行通信，而是与设备控制器通信。

1. 数据信号线。用于在设备与控制器之间传输数据
2. 控制信号线。作为由设备控制器向I/O设备发送控制信号的通路
3. 状态信号线。用于传送指示当前设备状态的信号。

#### 1.2 设备控制器

> 设备控制器是一个计算机中的实体，主要职责：控制一个或多个I/O设备，以实现I/O设备和计算机之间的数据交换。是CPU与I/O设备之间的接口，它接收从CPU发来的命1令，并去控制I/O设备工作，使处理机从繁杂的设备控制事务中解脱出来。

｜设备控制器的基本功能

1. 接收和识别命令。CPU可以向控制器发送命令，控制器应能接收和识别这些命令。
2. 数据交换。实现CPU与控制器，控制器与设备之间的数据传输
3. 标示和报告设备状态。控制器标示设备的状态供CPU了解
4. 地址识别。系统中的每一个设备都有一个地址，设备控制器能识别它控制的所有设备的地址
5. 数据缓冲。由于CPU速度与I/O差距很大，故需要早控制器内设置一缓冲区

｜设备控制器的组成

1. 设备控制器与CPU之间的接口。该接口用于实现CPU与设备控制器的信息传输。三类信号线：数据线，地址线，控制线
2. 设备控制器与设备之间的接口
3. I/O逻辑

#### 1.3 I/O通道

> 增加I/O通道的目的是为了建立独立的I/O操作，不仅使数据的传输能独立于CPU，而且希望有关对I/O操作的组织，管理及其结束都尽量独立。

｜通道类型

1. 字节多路通道
2. 数组选择通道
3. 数组多路通道

#### 1.4 总线系统

1. ISA与EISA
2. 局部总线。指将多媒体卡，高速LAN网卡，高性能图形板等从ISA总线上卸下来，在通过局部总线控制器直接接到CPU上。
   1. VESA
   2. PCI

### 2 I/O控制方式

#### 2.1 程序I/O方式

> 早期无中断机构，处理机对I/O设备的控制采取程序I/O方式，即：忙-等方式。
>
> 忙-等：处理机想控制器发出一条I/O指令启动输入设备输入数据时，同时把状态寄存器中忙标志busy置1，然后不断循环测试busy。当busy=1时，标示未输完，处理机继续测试，直至busy=0

这种方式使CPU的大部分时间都处于等待I/O设备完成数据I/O的循环测试中，造成CPU的浪费。

#### 2.2 中断驱动I/O方式

> 当某个进程要启动某个I/O设备时，由CPU向相应的设备控制器发出一条I/O设备，然后立即返回继续执行原来的任务。设备控制按照该命令去控制I/O设备，一旦数据进入数据寄存器，控制器变向CPU发送中断信号，若无差错，便向控制器发出取出数据的信号，之后通过控制器及数据线将数据写入内存。此时CPU与I/O设备并行。

#### 2.3 DMA I/O方式

> 中断方式是以字节为单位进行I/O的，每当完成一个字节时，控制器便要向CPU请求一次中断。
>
> 这种方式对于块设备的I/O是很低效的，为了进一步减少CPU对于I/O的干预，引入DMA方式。

｜DMA方式的特点

1. 数据传输的基本单位是数据块。即：在CPU与I/O设备之间，每次传送至少一个数据块
2. 所传输的数据是设备直接送入内存
3. 仅在传送一个或多个数据块的开始和结束时，才需CPU干预

｜DMA控制器组成（主机与控制器的接口）

<img src="/Users/verdure/Library/Application Support/typora-user-images/image-20210424104611851.png" alt="image-20210424104611851" style="zoom:50%;" />

1. 命令/状态寄存器。接收CPU发来的I/O命令或有关控制信息
2. 内存地址寄存器。输入时，存放从设备传输到内存的起始目标地址；输出时，存放由内存到设备的内存源地址
3. 数据寄存器。存设备到内存，内存到设备的数据
4. 数据计数器。存放本次CPU要读或写的字数

｜DMA工作过程

#### 2.4 I/O通道控制方式

> 对于DMA方式，当我们需要一次去读多个数据块且将它们分别传送到不同的内存区域，则需CPU分别发出多条I/O指令及进行多次中断处理才能完成。
>
> I/O通道方式可以进一步减少CPU的干预，即把对一个数据块的读（或写）为单位的干预减少为对一组数据块的读（或写）及有关的控制和管理为单位的干预。

### 3 缓冲管理

｜引入缓冲的原因

1. 缓和CPU与I/O设备间速度不匹配的矛盾
2. 减少对CPU的中断频率，放宽对CPU中断响应时间的限制
3. 提高I/O设备与CPU的并行性

#### 3.1 单缓冲与双缓冲

｜单缓冲

单缓冲情况下，每当用户进程发出一I/O请求时，操作系统便在主存中为之分配一缓冲区。

<img src="/Users/verdure/Library/Application Support/typora-user-images/image-20210424110741616.png" alt="image-20210424110741616" style="zoom:50%;" />

假定从磁盘把一块数据输入到缓冲区的时间为T，操作系统将该缓冲区中数据传送到用户区时间为M，CPU处理的时间为C。T和C并行

故：当T>C时，当I/O设备输入完成时，CPU还未处理完，故需等待CPU处理完成之后，取走缓冲区的数据后，I/O设备可以再次向缓冲区送入数据。系统对每一块数据处理时间为：M+T；当T<C时，同理，系统对每一块数据处理时间为：C+M

即：
$$
处理时间为：Max(C, T) + M
$$
｜双缓冲

在设备输入时，先将数据送入第一缓冲区，装满之后便转向第二缓冲区。此时OS可以从第一缓冲区中移出数据，并送入用户进程。

<img src="/Users/verdure/Library/Application Support/typora-user-images/image-20210424111325136.png" alt="image-20210424111325136" style="zoom:50%;" />

故：若C<T，则表示设备可以连续输入；若C>T，表示CPU不必等待设备输入

#### 3.2 循环缓冲

### 4 I/O软件

#### 4.1 中断程序

> 